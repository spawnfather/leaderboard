<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spawn Board</title>

    <meta name="title" content="Spawn Board - Spawnism Leaderboard" />
    <meta name="description" content="The leaderboard of active Spawnism communities compared by their member counts displayed in an easy to understand format." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://spawnboard.pages.dev/" />
    <meta property="og:title" content="Spawn Board - Spawnism Leaderboard" />
    <meta property="og:image" content="https://i.ibb.co/qMZM2P5P/SPAWN-BOARD.png" />
    <meta property="og:description" content="The leaderboard of active Spawnism communities compared by their member counts displayed in an easy to understand format." />

    

    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://spawnboard.pages.dev/" />
    <meta property="twitter:title" content="Spawn Board - Spawnism Leaderboard" />
    <meta property="twitter:image" content="https://i.ibb.co/qMZM2P5P/SPAWN-BOARD.png" />
    <meta property="twitter:description" content="The leaderboard of active Spawnism communities compared by their member counts displayed in an easy to understand format." />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <link rel="stylesheet" href="/styles.css">
    
</head>
<body>

    <header>
        <div class="nav-container">
            <nav>
                <ul>
                    <li><a href="/leaderboard">Leaderboard</a></li>
                    <li><a href="/submit">Submit Server</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <div class="container">
        <h1>Server Leaderboard</h1>
        <button id="refresh-btn">Refresh</button>
        <p id="last-updated" style="text-align: center; font-style: italic; color: #7f8c8d; margin: 10px 0;"></p>
        <div class="toggle-container">
            <label for="dark-toggle">Dark Theme</label>
            <label class="toggle-switch">
                <input type="checkbox" id="dark-toggle">
                <span class="slider"></span>
            </label>
        </div>
        <div id="loading">Loading data...</div>
        <table id="leaderboard">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Server Name</th>
                    <th>Member(s)</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be populated here -->
            </tbody>
        </table>
    </div>

    <script type="module">

        function getMedal(rank) {
            
            if (rank === 1) return 'ðŸ¥‡';
            if (rank === 2) return 'ðŸ¥ˆ';
            if (rank === 3) return 'ðŸ¥‰';
            return 'ðŸ…';
        }

        import { createClient } from
      'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        // Replace with your Supabase URL and anon key
        const SUPABASE_URL = 'https://gzrsknywsqpfimeecydn.supabase.co'; // e.g., https://abc123.supabase.co
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6cnNrbnl3c3FwZmltZWVjeWRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNzc3MDgsImV4cCI6MjA3NjY1MzcwOH0.hjBoZqa-BC41cnbknzwkM36mER2I-3gsk-hUp7CVaWA'; // Get from Supabase dashboard

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const tbody = document.querySelector('#leaderboard tbody');
        const loading = document.getElementById('loading');
        const refreshBtn = document.getElementById('refresh-btn');
        const lastUpdated = document.getElementById('last-updated');

        async function fetchAndDisplayData() {
            loading.style.display = 'block';
            tbody.innerHTML = ''; // Clear existing data
            lastUpdated.textContent = '';

            try {
                let { data, error } = await supabase
                    .from('leaderboardmain')
                    .select('server_name, member_count, invite_code, last_updated')
                    .order('member_count', { ascending: false });

                if (error) throw error;

                if (data && data.length > 0) {
                    // ---- REPLACE THE ENTIRE data.forEach(...) BLOCK WITH THIS ----
                    data.forEach((item, index) => {
                    const row = document.createElement('tr');
                    const rank = index + 1;

                    // Rank + medal
                    const rankTd = document.createElement('td');
                    rankTd.textContent = `${rank} ${getMedal(rank)}`;
                    row.appendChild(rankTd);

                    // Server name (XSS-safe)
                    const nameTd = document.createElement('td');
                    nameTd.textContent = item.server_name || 'â€”';
                    row.appendChild(nameTd);

                    // Member count
                    const countTd = document.createElement('td');
                    countTd.textContent = item.member_count ?? 'â€”';
                    row.appendChild(countTd);

                    // ---------- NEW "Join Server" BUTTON ----------
                    const actionsTd = document.createElement('td');

                    // Guard against missing/empty invite codes
                    const inviteCode = (item.invite_code || '').trim();
                    if (inviteCode) {
                        const joinBtn = document.createElement('a');
                        joinBtn.href = `https://discord.gg/${encodeURIComponent(inviteCode)}`;
                        joinBtn.target = '_blank';
                        joinBtn.rel = 'noopener noreferrer';
                        joinBtn.className = 'join-btn';
                        joinBtn.textContent = 'Join Server';
                        actionsTd.appendChild(joinBtn);
                     }           
                        
                    const pageBtn = document.createElement('a');
                    pageBtn.href = `https://spawnboard.pages.dev/server/${item.guild_id}`; // Replace with the relative or absolute URL to the other page on your website
                    pageBtn.target = '_blank'; // Opens in new tab; remove or set to '_self' if you want same tab
                    pageBtn.rel = 'noopener noreferrer';
                    pageBtn.className = 'join-btn'; // Reuse class for consistent styling; adjust if needed
                    pageBtn.textContent = 'More Details'; // Replace with your desired button text
                    actionsTd.appendChild(pageBtn); // Appends next to Join Server if present (add CSS like 'margin-left: 10px;' for spacing if needed)

                    if (actionsTd.childNodes.length === 0) {
                        actionsTd.textContent = 'â€”';
                    }

                    row.appendChild(actionsTs);
                    tbody.appendChild(row);
                });

                    const maxUpdated = data.reduce((max, item) => 
                        (item.last_updated > max ? item.last_updated : max), 
                        data[0].last_updated
                    );

                    lastUpdated.textContent = `Last Updated: ${new Date(maxUpdated).toLocaleString('en-US', {year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true})}`;
                    
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No data available</td></tr>';
                    lastUpdated.textContent = "Last Updated: N/A";
                }
            } catch (err) {
                console.error('Error fetching data:', err);
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: red;">Error loading data. Please try again.</td></tr>';
                lastUpdated.textContent = "Last Updated: Error";
            } finally {
                loading.style.display = 'none';
            }
        }

        // Initial load
        fetchAndDisplayData();

        // Refresh button
        refreshBtn.addEventListener('click', fetchAndDisplayData);

        // Dark Theme Toggle
        const darkToggle = document.getElementById('dark-toggle');

        // Load saved theme preference
        if (localStorage.getItem('darkTheme') === 'true') {
            document.body.classList.add('dark-theme');
            darkToggle.checked = true;
        }

        // Toggle event listener
        darkToggle.addEventListener('change', () => {
            if (darkToggle.checked) {
                document.body.classList.add('dark-theme');
                localStorage.setItem('darkTheme', 'true');
            } else {
                document.body.classList.remove('dark-theme');
                localStorage.setItem('darkTheme', 'false');
            }
        });

    </script>
    
    <footer>
        &copy; 2025 SpawnBoard. All rights reserved.
        <span>
            <a href="/privacy">Privacy Policy</a>
        </span>
    </footer>
</body>
</html>
